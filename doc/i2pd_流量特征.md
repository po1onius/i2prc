# I2P匿名通信流量特征分析

[https://m.fx361.com/news/2020/0325/14328495.html](https://)

<h2>0 引 言</h2>
                        <p>随着计算机网络的高速发展，越来越多的信息通过网络进行传输。然而，最近发生的多起用户信息泄露事件也给受害者带来了损失，用户在上网过程中不希望自己的身份被其他人获取。匿名通信网络就是为了隐藏通信双方的身份而设计的，使用匿名通信网络可以防止自己的身份被对方或监听者获取，从而保护用户的身份。Chaum在1981年最先提出基于MIX网络的匿名通信技术[1]。由于MIX网络可以提供强大的匿名性，因此目前大多数匿名通信网络均使用MIX网络对用户身份提供保护。I2P就是一种使用非常广泛的基于MIX网络的匿名通信网络，通过随机选择MIX网络中的节点组成通信链路为用户提供匿名。同时，I2P提供了Eepsite和LeaseSet，使服务器可以在隐藏身份的情况下与用户进行通信。正是由于I2P提供了强大的匿名性，使得很多违法分子通过I2P进行违法犯罪活动[2]。</p>
                        <p>国内外目前已有大量针对匿名通信网络及其流量识别技术的研究。在国外，Conrad等人在文献[3]中对Tor和I2P网络进行了对比；Bernaille等[4]提出了通过观察TCP流的前5个数据包对应用进行识别；Raahemi等[5]通过对IP层数据进行挖掘识别P2P流量；Mayank等[6]提出了RDClass的算法，通过流量与关键字集合之间的距离对应用进行识别；Staravoitau[7]提出了通过对数据进行预处理后，使用卷积神经网络对流量进行识别，准确率达到99.33%。在国内，方鹏[8]使用了TCP特征和聚类的方式对恶意TCP流进行识别，并标记恶意流量；何高峰等[9]通过Tor流量的TLS和长度分布特征对Tor流量进行识别；李响[10]对使用Meek网桥的Tor流量进行深入分析，使用多级过滤和SVM相结合的方式，对基于Meek的Tor流量进行识别；李金栓[11]对I2P流量特征进行分析，使用多级过滤和遗传算法对I2P流量进行识别，实现了一个原型系统。</p>
                        <p>目前，针对匿名通信网络的研究主要集中在Tor的流量识别，很少有关于I2P流量识别的文献。同时，I2P新加入的NTCP2协议也给I2P流量带来了新的特征，因此有必要对最新版I2P的流量特征进行研究，并设计算法识别其流量。本文对加入NTCP2协议后的I2P流量特征进行研究，并实现了一个用于识别I2P流量的原型系统。</p>
                        <h2>1 I2P运行原理</h2>
                        <p>对I2P运行原理和传输层协议进行分析，包括I2P隧道建立、转发过程以及I2P路由节点之间进行通信的协议——SSU、NTCP和NTCP2。</p>
                        <p>I2P是一种广泛使用的匿名通信网络，可以用于匿名浏览网页、匿名邮件及匿名文件共享等。I2P在发送数据时会使用节点选择算法从netDB中随机选择一定数目的节点组成单向的传入隧道（Inbound Tunnel）和传出隧道（Outbound Tunnel）。其中，传入隧道用于接收数据，传出隧道用于发送数据，隧道中的每个节点都只知道它的上一跳和下一跳节点。路由间数据通过I2P传输层协议进行传输。</p>
                        <p>下面介绍I2P的网络数据库、隧道建立和传输层协议。</p>
                        <h3>1.1 网络数据库</h3>
                        <p>I2P netDB是一个分布式数据库，保存有路由节点信息（RouterInfos）和赁集（LeaseSets）两种信息。它们都经过签名，任何使用这些数据的节点都可以通过签名验证这些信息。其中，RouterInfo记录了路由节点的身份（包括加密密钥、签名密钥和证书）、IP地址和端口等信息。</p>
                        <h3>1.2 隧 道</h3>
                        <p>当I2P需要进行通信时，客户端建立传入隧道和传出隧道。隧道建立时，I2P随机从netDB中选择节点建立单向传输的隧道。由于隧道是单向的，因此为了完成通信，至少需要建立一条用于发送数据的传出隧道和一条用于接收数据的传入隧道。</p>
                        <h3>1.3 传输层协议</h3>
                        <p>I2P路由节点之间通过传输层协议进行通信，高层协议经过I2P传输层协议进行封装后通过TCP或UDP发送到目标路由节点。I2P的传输层有安全半可靠UDP（Secure Semireliable UDP，SSU）、NTCP和NTCP2三种协议。</p>
                        <p>1.3.1 SSU</p>
                        <p>SSU在UDP协议的基础上实现半可靠的、加密的、面向连接的和点到点的数据传输服务。SSU连接建立过程如图1所示。</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/e9f2646e143cd3b375df37d7f5df115609649abf.webp"/>
                        </p>
                        <p>图1 SSU会话建立</p>
                        <p>1.3.2 NTCP</p>
                        <p>NTCP使用TCP协议，是一种基于Java NIO的传输层协议。NTCP建立过程如图2所示。</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/ccd32bbed18c5d6b6dc0a8921f3c5227e4c982cc.webp"/>
                        </p>
                        <p>图2 NTCP会话建立</p>
                        <p>1.3.3 NTCP2</p>
                        <p>NTCP2在I2P 0.9.36中被引入，NTCP2使用Noise协议框架。NTCP2可以与NTCP运行在同一端口或者不同端口。NTCP2建立连接的过程如图3所示。</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/13a8c656ac3d473d2c1702b15e330cf5708b5718.webp"/>
                        </p>
                        <p>图3 NTCP2会话建立</p>
                        <h2>2 I2P报文特征分析</h2>
                        <p>通过运行I2P并进行抓包获取包含I2P流量的数据包，并使用netDB中RouterInfo对数据流进行标记，最后分析I2P数据流特征。由于NTCP和NTCP2协议可以同时运行，因此下文不再区分NTCP和NTCP2协议。</p>
                        <h3>2.1 载荷长度特征</h3>
                        <p>提取捕获到的数据包的载荷长度，分别绘制载荷长度分布直方图，如图4和图5所示。可以看出，无论是基于TCP还是UDP的协议，均存在载荷长度较小的数据包，且这样的数据包占了很大比重，长度较大的载荷长度根据协议的不同有较大差异。根据第1节的描述，由于I2P隧道是单向的，因此隧道反向传输的数据只有确认包，数据量较小。然而，通过对大量的I2P数据流进行分析发现，虽然大部分数据流符合该特征，但仍有小部分上下行数据量大致相同。</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/71707177b411aa9aa3eec17c1e0f9ff31d32ad1b.webp"/>
                        </p>
                        <p>图4 基于TCP的I2P数据流载荷长度分布</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/304e60663cc56f3372551e2223354db8a7ec2b53.webp"/>
                        </p>
                        <p>图5 基于UDP的I2P数据流载荷长度分布</p>
                        <p>为了进一步得到I2P数据流载荷长度的特征，下面分析其载荷长度的统计量。由于基于TCP和UDP的I2P流量有较大差异，因此需要分别对其进行研究。同时，I2P流量的载荷长度可以明显分为两种，长度较大的载荷一般用于数据的发送，长度较小的载荷用于对报文的确认。由于载荷长度大小对流量特征也有较大影响，因此本文设定了一个len_threshold，大于该长度的载荷视为长度较大载荷，小于该长度的视为长度较小的载荷。通过计算不同基于UDP的I2P数据流的统计量，绘制成图6、图7和图8。</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/bd482625948facd122dfbdbc61dae151a38b6102.webp"/>
                        </p>
                        <p>图6 基于UDP的I2P数据流载荷长度期望</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/5bd9b869deeb921ad990ef5defa30ac7cb668543.webp"/>
                        </p>
                        <p>图7 基于UDP的I2P数据流载荷长度标准差</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/1382201bf1072f2778fcb8f41a23f2a05990b071.webp"/>
                        </p>
                        <p>图8 基于UDP的I2P数据流载荷长度熵</p>
                        <p>从图6、图7和图8可以看出，基于UDP的I2P流量具有一定的统计特性，尤其是用于确认的长度较小的载荷，期望分布于0～200，标准差分布于0～50，熵分布于0～30。</p>
                        <p>本文使用同样的方法绘制了基于TCP的I2P数据流的统计特征图，如图9、图10和图11所示。</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/819b653120c172fce81bc6b3a04c94d9f94cdf9b.webp"/>
                        </p>
                        <p>图9 基于TCP的I2P数据流载荷长度期望</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/1d9e33b2369a3bd84787e0137053e0d4e6b9a6ed.webp"/>
                        </p>
                        <p>图10 基于TCP的I2P数据流载荷长度标准差</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/c0e4ab4b0cc938f884938feb4092988150f1d72d.webp"/>
                        </p>
                        <p>图11 基于TCP的I2P数据流载荷长度熵</p>
                        <p>从图9、图10和图11可以看出，基于TCP的I2P数据流小长度载荷长度的统计特征较UDP更为明显，TCP较小载荷长度期望分布在0～20，标准差分布在0～300，载荷长度熵分布于0～10。长度较大的载荷期望分布在1 000～2 500，大部分标准差小于1 000。</p>
                        <h3>2.2 载荷长度序列特征</h3>
                        <p>在第1节中介绍了I2P传输层连接建立的过程，从连接过程交换的信息来看，I2P传输层协议在连接建立过程中可能存在明显的长度序列模式。下面截取部分基于TCP的I2P传输层建立会话过程的数据流，如图12所示。</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/782d118376185c73be22b1cf13f40b36a874d71e.webp"/>
                        </p>
                        <p>图12 基于TCP的I2P传输层建立连接</p>
                        <p>图13对比了3条基于TCP的数据流，可以看出数据流的前几个数据包的载荷长度序列有一定的大小范围。基于UDP的I2P数据流也有类似的模式，部分数据流如图13所示。</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/fd3688b3c2fe70d17eb769836cd7b6847ae72090.webp"/>
                        </p>
                        <p>图13 基于UDP的I2P传输层建立连接</p>
                        <p>从图13可以看出，基于UDP的I2P流量有着更为明显的特征，尤其是第3个载荷长度固定为512 Byte。</p>
                        <h3>2.3 载荷特征</h3>
                        <p>I2P载荷经过加密处理，因此载荷无明显特征。然而，这与其他加密协议如TLS有明显区别。在TLS协议中，安全传输层载荷开始处会记录数据类型、协议版本和长度等信息。</p>
                        <h3>2.4 首部标志特征</h3>
                        <p>根据对大量I2P流量数据包网际互联层和传输层的头部分析发现，I2P流量的IP头部的TOS字段均为0，TCP头部的PSH位置位，如图12所示。</p>
                        <h3>2.5 端口号</h3>
                        <p>根据I2P官方网站的描述，I2P在运行时会从大于1 024的端口号中随机选取一个端口号进行通信。观察大量的I2P数据包，也证实了这个描述。</p>
                        <h3>2.6 确认到达时间差</h3>
                        <p>在TCP协议中，接收到数据包后要返回ACK确认数据包到达时间。本文通过计算ACK数据包发送时间和相应数据包的差值绘制成图14。</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/54c4fdf05d1802274249d71a82cb94bea0576d07.webp"/>
                        </p>
                        <p>图14 确认到达时间差</p>
                        <p>从图14中可以看出，I2P数据流确认到达数据包的发出时间差集中在0.2～0.5 s，初始的几个报文时间差较小。同时，受到网络波动和计算量的影响，少部分数据包的时间差可能超出范围。</p>
                        <h2>3 算法设计与实现</h2>
                        <p>将根据第2节对I2P流量特征的分析结果，设计并实现一套算法实现对I2P流量进行过滤，并对算法进行测试。</p>
                        <p>本文首先通过端口号过滤掉端口小于等于1 024的数据流，然后对数据流的其他特征进行检查，如果通过所有检查，则认为是I2P数据流。</p>
                        <p>算法如下：</p>
                        <p>（1）读入捕获的数据包并重新建立数据流，去除数据流中重传帧；</p>
                        <p>（2）提取数据流的首部标志位特征、载荷长度特征、TCP数据流确认时间和载荷前十个字节；</p>
                        <p>（3）检查数据流端口号，如果小于等于1 024，则认为不是I2P数据流；</p>
                        <p>（4）检查首部特征，如果不符合I2P数据流的首部特征，则认为不是I2P数据流；</p>
                        <p>（5）检查载荷前10字节是否包含载荷长度信息以及同一数据流相同位置字节的相关性，如果包含或相关性过大，则认为不是I2P数据流；</p>
                        <p>（6）如果是TCP流，则检查确认报文发出时间差，如果有一定比例的数据包超出范围，则认为不是I2P数据流；</p>
                        <p>（7）设定长度len_threshold，根据len_threshold将载荷长度分成两部分，小于len_threshold的记为Y，大于len_threshold的记为Z；</p>
                        <p>（8） 计 算 E(Y)、D(Y)和 H(Y)，如 果 E(Y)、D(Y)或H(Y)不在I2P较小载荷的期望、标准差和长度熵区间内，则认为不是I2P流量；</p>
                        <p>（9）计算 E(Z)和 H(Z)，如果 E(Z)或 H(Z)不在I2P较大载荷的期望和长度熵区间内，则认为不是I2P流量；</p>
                        <p>（10）如果通过以上所有检查，则认为是I2P流量。</p>
                        <p>根据以上算法，本文使用python开发了一套用于检测I2P流量的原型系统。为了使实验结果更加准确，本文在不同环境重新抓取了包含I2P流量的数据包，共获取到34 926条数据流，其中包含5 583条I2P数据流。运行流量识别原型系统对流量进行识别，结果如表1所示。</p>
                        <p>
                            <img src="https://cimg.fx361.com/images/2023/0107/ca01c3a75509027b590e6207c4d0fa435eac0b11.webp"/>
                        </p>
                        <p>表1 实验结果</p>
                        <p>从表1可以计算出，该原型系统对I2P流量识别的精确度（Accuracy）达到93%，召回率达到94%，证明该系统可以有效识别I2P流量。</p>
                        <h2>4 结 语</h2>
                        <p>本文首先对I2P原理和传输层协议进行介绍，其次重点分析I2P数据流存在的统计学特征，最后根据I2P数据流的统计学特征设计了一套算法对I2P流量进行识别。实验结果表明，该算法具有较高的精确度和召回率。</p>
                        <p>在本文的基础上未来可以从以下几个方向对I2P流量识别算法进行进一步优化：</p>
                        <p>（1）进一步丰富数据流的种类，对流量识别算法进行进一步优化；</p>
                        <p>（2）可以通过抓取I2P路由节点信息，直接使用路由节点信息识别数据流；</p>
                        <p>（3）可以利用机器学习算法进行进一步识别，提高精确度。</p>
                    </div>
                </div>
                <!--       <div class="m_article_pdf"><a href="https://cimg.fx361.com/kkb.apk">查看pdf文档请下载app</a></div>-->
                <div class="article_love_part">

## i2CP协议

I2NP（I2P Network Protocol）则是在I2P网络中节点之间传输消息的协议。



### 首部流量特征

#### 抓包分析

##### i2p流发起端首部特征

##### i2p流回复包首部特征

#### 代码分析

##### 组包







